---
title: "CO2"
author: "Paige Hill, Lauren McIntosh, Amaya Owens"
format:
  dashboard:
    theme: flatly
    orientation: rows
    embed-resources: true
jupyter:
  kernelspec:
    name: python3
    display_name: Python 3
    language: python
---

```{python}
#| label: info
#| include: false


import pandas as pd
import altair as alt
import numpy as np
from great_tables import GT
import matplotlib.pyplot as plt
alt.renderers.enable('html')

df = pd.read_csv("Data.csv")

# create subset of data
df.dropna(subset=["year", "Name", "gdp", "population", "temperature_change_from_co2", "co2_per_capita"],inplace=True)
df2=df[["year", "Name", "gdp", "population", "co2_per_capita", "temperature_change_from_co2"]].query("year > 1950")

world_df = df2.query("Name == 'World'")
final_df = df2.query("Name != 'World'")

regions = pd.read_csv("./country_regions.csv")


```

# Overview
## Row {height="200px"}
```{python}
#| content: valuebox
#| title: "Number of Countries:"
#| icon: "globe-americas"
#| color: "primary"
num_countries = final_df['Name'].nunique()

dict(
  value = f"{num_countries}"
)
```

```{python}
#| content: valuebox
#| title: "Wost CO2 Emission Per Capita in 2022:"
#| icon: "exclamation-lg"
#| color: "danger"
by_emissions = final_df.sort_values(by="co2_per_capita", ascending = False).query("year == 2022")
country = by_emissions.iat[0,1]
per_capita = by_emissions.iat[0,4]
dict(
  value = f"{country}"
)
```

```{python}
#| content: valuebox
#| title: "Temperature limit set by Paris Accords:"
#| icon: "thermometer"
#| color: "secondary"

dict(
  value = "2 °C"
)
```

## Row 
```{python}
#| code-fold: true
world_df = df[["year", "Name", "temperature_change_from_co2"]].query("Name == 'World' and year >= 1950 ")
x=world_df['year']
y=world_df['temperature_change_from_co2']
z2=np.polyfit(x,y,2)
p2 = np.poly1d(z2)
world_df.loc[len(world_df)]=[2070, "World", p2(2070)]
source = pd.DataFrame({
    'x' : pd.to_datetime(world_df['year'], format='%Y'),
    'y' : world_df["temperature_change_from_co2"]
})

base = alt.Chart(source).mark_line(color="#3498db", strokeWidth=3).encode(
    x=alt.X(
        "x:T",
        title="Year",
        axis=alt.Axis(format='%Y', tickCount='year')
    ),
    y=alt.Y('y', title= 'Temp (°C)'),
)

rect_data = pd.DataFrame([{'x1': pd.to_datetime(1950, format="%Y"), 'x2': pd.to_datetime(2070, format="%Y"), 'y1': 2, 'y2': 3}])
highlight = alt.Chart(rect_data).mark_rect(
    color='red', 
    opacity=0.2
).encode(
    x='x1',
    x2='x2',
    y='y1',
    y2='y2'
)

world_chart = (base + highlight).properties(title="Global Temperature Change From CO2 vs Time").interactive()
world_chart
```

# GDP
## Row {height="60px"}
<div style="font-size: 15pt">Is higher GDP correlated to higher CO2 emissions?</div>

## Row
### {width="400px"}
<div style="color: red">
* Red - Avg CO2 Emissions per Country 
</div>
<div style="color: blue">
* Blue - Avg GDP per Country
</div>

| Metric | Value | Interpretation |
|:---:|:---:|:---:|
| GDP-CO2 Correlation | 0.964 | Exceptionally strong relationship |
| GDP Growth (1950-2022) | 1,186% | 12x increase in average GDP |
| CO2 Growth (1950-2022) | 414% | 5x increase in average emissions |

###
```{python}
#| code-fold: true

df_co2 = pd.read_csv("Data.csv")

# Apply filters for GDP-CO2 analysis
df_filtered = df_co2[(df_co2["year"] >= 1950) & (df_co2["year"] <= 2023)].copy()
df_filtered = df_filtered[df_filtered["Description"] == "Country"].copy()
df_filtered = df_filtered[~df_filtered["Name"].str.endswith("(GCP)", na=False)].copy()
df_filtered = df_filtered.dropna(subset=["Name", "co2", "gdp"]).copy()

# Calculate global averages by year (mean across all countries)
yearly_averages = (
    df_filtered.groupby("year").agg({"co2": "mean", "gdp": "mean"}).reset_index()
)

# Define tick values for every 5 years from 1950-2022
tick_values = [1950, 1955, 1960, 1965, 1970, 1975, 1980, 1985, 1990, 1995, 2000, 2005, 2010, 2015, 2020, 2022]

# CO2 chart
co2_chart = (
    alt.Chart(yearly_averages)
    .mark_line(
        color="#e74c3c", strokeWidth=3
    )
    .encode(
        x=alt.X(
            "year:O",
            title="Year",
            axis=alt.Axis(
                labelAngle=-45, values=tick_values, labelExpr="datum.value + ''"
            ),
        ),
        y=alt.Y(
            "co2:Q",
            title="Average CO2 Emissions per Country (MtCO2)",
            axis=alt.Axis(titleColor="#e74c3c", labelColor="#e74c3c"),
        ),
        tooltip=[
            alt.Tooltip("year:O", title="Year"),
            alt.Tooltip("co2:Q", title="Avg CO2 per Country (MtCO2)", format=",.1f"),
            alt.Tooltip("gdp:Q", title="Avg GDP per Country (USD)", format="$,.0f"),
        ],
    )
)

# GDP chart (independent y-axis)
gdp_chart = (
    alt.Chart(yearly_averages)
    .mark_line(
        color="#3498db",
        strokeWidth=3
    )
    .encode(
        x=alt.X(
            "year:O", axis=alt.Axis(values=tick_values, labelExpr="datum.value + ''")
        ),
        y=alt.Y(
            "gdp:Q",
            title="Average GDP per Country (USD)",
            scale=alt.Scale(zero=False),
            axis=alt.Axis(titleColor="#3498db", labelColor="#3498db", format="$.0f", labelExpr="'$' + datum.value/1000000000 + 'B'"),
        ),
        tooltip=[
            alt.Tooltip("year:O", title="Year"),
            alt.Tooltip("co2:Q", title="Avg CO2 per Country (MtCO2)", format=",.1f"),
            alt.Tooltip("gdp:Q", title="Avg GDP per Country (USD)", format="$,.0f"),
        ],
    )
)

# Combine with independent y-axes
gdp_co2_chart = (
    alt.layer(co2_chart, gdp_chart)
    .resolve_scale(y="independent")
    .properties(
        width=900,
        height=450,
        title=alt.TitleParams(
            text="Average GDP vs CO2 per Country (1950-2022)",
            fontSize=16,
        ),
    )
)

gdp_co2_chart
```

# Population

## Row {height="60px"}
<div style="font-size: 15pt">Is population correlated to higher CO2 emissions per capita?</div>

## Row 
### {width="300px"}
* No clear relationship in the data
* Indicates there is no reason to believe that population has an impact on per capita emissions

###
```{python}
#| code-fold: true
population_region_df = pd.merge(final_df, regions, how="inner", on="Name")
population_df = population_region_df.query("year > 2016").assign(log_population = lambda x: np.log(x['population']))
region_list = population_df['Region'].unique().tolist()
dropdown = alt.binding_select(
    options=region_list,
    name='Select Region: '
)

dropdown_selection = alt.selection_point(
    fields=['Region'],  
    bind=dropdown
)

click_selection = alt.selection_point(fields=['Region'])
hover_selection = alt.selection_point(
    on="mouseover", fields=['Name'], empty=False
)

population_chart = (
    alt.Chart(population_df)
    .mark_circle()
    .encode(
        y=alt.Y('co2_per_capita', title="CO2 Emissions Per Capita (Tonnes Per Person)"),
        x=alt.X('log_population', title="log(Population)"),
        tooltip=['Name', 'co2_per_capita', 'population', 'year'], 
        color = alt.when(hover_selection)
            .then(alt.value("red"))
            .otherwise(
                alt.Color("Region:N")
            ),
        size=alt.when(hover_selection)
            .then(alt.value(300))
            .when(click_selection)
            .then(alt.value(100))
            .otherwise(alt.value(50)),
        opacity=alt.when(hover_selection)
            .then(alt.value(1))
            .when(click_selection)
            .then(alt.value(1))
            .otherwise(alt.value(0.3))
    )
    .properties(
        width=900,
        height=450,
        title=alt.TitleParams(
            text="CO2 Emissions Per Capita vs Population (2017-2022)",
            fontSize=16,
             )
    )
    .add_params(
    click_selection, hover_selection, dropdown_selection
    )
    .transform_filter(
        dropdown_selection
    )
    .interactive())
population_chart

```
# Temperature
## Row {height="60px"}
<div style="font-size: 15pt"> Are CO2 emissions related to higher temperatures? </div>

## Row
### {width="400px"}
<div style="color: blue">
* Blue - CO2 Emissions
</div>
<div style="color: red">
* Red - Global Temperature Change
</div>
| Metric | Value | Interpretation |
|:---:|:---:|:---:|
| GDP-CO2 Correlation | 0.84 | Strong relationship |
| Temp Change (1960-2022) | 292% | 2x increase in average temperature change |
| CO2 Growth Per Capita (1960-2022) | 95% | Increase in per capita emissions |

###
```{python}

#temp vs co2 for the world

#World data only
world_df = df2[df2["Name"] == "World"]

source = pd.DataFrame({
    'x': pd.to_datetime(world_df['year'], format="%Y"),
    'y': world_df['co2_per_capita']
})

#baseline co2 emissions
co2_line = (
    alt.Chart(source)
    .mark_line(color="#3498db", strokeWidth = 3)
    .encode(
        x=alt.X('x:T', title="Year", axis=alt.Axis(format='%Y')),
        y=alt.Y('y:Q', title="CO₂ Emissions (million tonnes)", axis=alt.Axis(titleColor="#3498db")),
        tooltip=[alt.Tooltip('x:T', title='Year', format='%Y'), alt.Tooltip('y:Q', title='CO₂ per capita')]
    )
)

source = pd.DataFrame({
    'x': pd.to_datetime(world_df['year'], format="%Y"),
    'y': world_df['temperature_change_from_co2']
})
#line for temp change with second axis
temp_line = (
    alt.Chart(source)
    .mark_line(color="#e74c3c", strokeWidth=3)
    .encode(
        x=alt.X('x:T', axis=alt.Axis(format='%Y')),
        y=alt.Y(
            "y:Q",
            title="Temperature Change from CO₂ (°C)",
            axis=alt.Axis(titleColor="#e74c3c")
        ),
        tooltip=[alt.Tooltip('x:T', title='Year', format='%Y'), alt.Tooltip('y:Q', title='Temperature Change')]
    )
)


#combine both lines, layered graph with two y-axes
co2_vs_temp = alt.layer(co2_line, temp_line).resolve_scale(y='independent').properties(
    title="CO₂ Emissions vs. Temperature Change (World)",
    width=900,
    height=450
)

co2_vs_temp
```


# Average CO2 By Country
```{python}
avg_co2_by_country = df2.groupby("Name", as_index=False)["co2_per_capita"].mean()

avg_co2_by_country = avg_co2_by_country[avg_co2_by_country["Name"] != "World"]

avg_co2_by_country = avg_co2_by_country.sort_values(by="co2_per_capita", ascending=False)

#print(avg_co2_by_country.head(10))
#print(avg_co2_by_country)
avg_country_table = GT(avg_co2_by_country.head(15))
avg_country_table.fmt_number(columns="co2_per_capita", compact=True).cols_label(co2_per_capita="CO2 Per Capita").tab_options(
        column_labels_background_color="#3498db"
    ).cols_align(columns="co2_per_capita", align="center" )

```

# Top 10 CO2 Emitters
```{python}
#| code-fold: true

# Load the CO2 emissions data
df_co2_pivot = pd.read_csv("Data.csv")
# Apply filters
# 1. Filter by year: 1950-2023
df_filtered_pivot = df_co2_pivot[(df_co2_pivot["year"] >= 1950) & (df_co2_pivot["year"] <= 2023)].copy()
# 2. Filter by Description: Only 'Country'
df_filtered_pivot = df_filtered_pivot[df_filtered_pivot["Description"] == "Country"].copy()
# 3. Filter by Name: Exclude strings ending with '(GCP)'
df_filtered_pivot = df_filtered_pivot[~df_filtered_pivot["Name"].str.endswith("(GCP)", na=False)].copy()
# 4. Remove rows with NaN values in our key columns
df_filtered_pivot = df_filtered_pivot.dropna(subset=["Name", "co2", "population", "gdp"]).copy()

# Create pivot table with Name as rows and co2, population, gdp as values
# Using pivot_table instead of groupby
pivot_table = pd.pivot_table(
    df_filtered_pivot,
    values=["co2", "population", "gdp"],
    index="Name",
    aggfunc="mean"
).round(2)

# Sort by CO2 emissions (highest to lowest)
pivot_table = pivot_table.sort_values("co2", ascending=False)

# Get top 10 for display
top_10_pivot = pivot_table.head(10)

# Create display version with cleaned up labels
formatted_pivot_table = top_10_pivot.copy()
formatted_pivot_table.reset_index(inplace=True)
formatted_pivot_table.columns = ["Name","Avg MtCO2", "Avg GDP", "Avg Population"]

# Format for better display
def format_number(x):
    if pd.isna(x):
        return "N/A"
    elif x >= 1e12:
        return f"${x/1e12:.1f}T"
    elif x >= 1e9:
        return f"${x/1e9:.1f}B"
    elif x >= 1e6:
        return f"${x/1e6:.1f}M"
    else:
        return f"${x:,.0f}"

def format_population(x):
    if pd.isna(x):
        return "N/A"
    elif x >= 1e9:
        return f"{x/1e9:.2f}B"
    elif x >= 1e6:
        return f"{x/1e6:.1f}M"
    else:
        return f"{x:,.0f}"

def format_co2(x):
    if pd.isna(x):
        return "N/A"
    else:
        return f"{x:,.1f}"


# Apply formatting to each column
formatted_pivot_table["Avg MtCO2"] = formatted_pivot_table["Avg MtCO2"].apply(format_co2)
formatted_pivot_table["Avg GDP"] = formatted_pivot_table["Avg GDP"].apply(format_number)
formatted_pivot_table["Avg Population"] = formatted_pivot_table["Avg Population"].apply(format_population)


# Now formatted_pivot_table contains the formatted data as a DataFrame
# You can display it with:
#print(formatted_pivot_table)

display_table = GT(formatted_pivot_table)
display_table.tab_header(title="Top 10 CO2 Emitting Countries (1950-2022)").tab_options(
        heading_background_color="#3498db"
    ).opt_horizontal_padding(scale = 2).cols_align(align="center")
```